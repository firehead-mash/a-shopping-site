{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">

  <!-- 上半部分：商品图片 + 信息 -->
  <div class="row">
    
    <!-- 商品图片区域 -->
    <div class="col-md-6 text-center">
      <div class="border p-3 rounded">
        {% if product.image %}
          <img src="{{ product.image.url }}" class="img-fluid rounded" style="max-height: 420px; object-fit: contain;">
        {% else %}
          <div class="bg-light p-5">无图片</div>
        {% endif %}
      </div>
    </div>

    <!-- 商品信息区域 -->
    <div class="col-md-6">
      <h2 class="fw-bold">{{ product.name }}</h2>

      <p class="text-muted mt-3">{{ product.description|linebreaksbr }}</p>

      <h3 class="text-danger fw-bold mt-4">¥{{ product.price }}</h3>

      <p class="mt-2">
        <span class="badge bg-success">库存：{{ product.stock }}</span>
      </p>

      <div class="mt-4">
        {% if user.is_authenticated %}
          <a href="{% url 'add_to_cart' product.pk %}" class="btn btn-lg btn-success px-4">
            <i class="bi bi-cart-plus"></i> 加入购物车
          </a>
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-lg btn-primary">登录后购买</a>
        {% endif %}
      </div>
    </div>

  </div>

  <hr class="my-5">

  <!-- 评论区 -->
  <div class="row">
    <div class="col-md-8">

      <h4 class="fw-bold mb-3">用户评论</h4>

      <!-- 评论列表 -->
      {% for c in product.comments.all|dictsortreversed:"created_at" %}
        <div class="border rounded p-3 mb-3 shadow-sm">

          <div class="d-flex justify-content-between">
            <strong>{{ c.user.username|default:"匿名" }}</strong>
            <small class="text-muted">{{ c.created_at|date:"Y-m-d H:i" }}</small>
          </div>

          <p class="mt-2">{{ c.content|linebreaksbr }}</p>

          {% if user.is_superuser %}
            <a class="btn btn-sm btn-danger" href="{% url 'delete_comment' c.id %}">
              删除
            </a>
          {% endif %}
        </div>
      {% empty %}
        <p class="text-muted">暂无评论，成为第一个评论的人吧！</p>
      {% endfor %}

      <!-- 添加评论 -->
      {% if user.is_authenticated %}
        <div class="mt-4">
          <h5 class="fw-bold">发表评论</h5>
          <form method="post" action="{% url 'add_comment' product.pk %}">
            {% csrf_token %}
            <textarea name="content" class="form-control" rows="3" placeholder="写下你的评论..."></textarea>
            <button class="btn btn-primary mt-2">提交评论</button>
          </form>
        </div>
      {% else %}
        <p>
          <a href="{% url 'login' %}?next={{ request.path }}">登录</a>后可以发表评论。
        </p>
      {% endif %}

    </div>
  </div>

</div>

{% endblock %}
